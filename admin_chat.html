<!DOCTYPE html>

<html lang="es">



<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Chat - Admin</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>

        * {

            margin: 0;

            padding: 0;

            box-sizing: border-box;

        }



        body {

            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

            background: #f8fafc;

            color: #1e293b;

            height: 100vh;

            overflow: hidden;

        }



        .chat-container {

            display: flex;

            flex-direction: column;

            height: 100vh;

            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);

        }



        /* HEADER */

        .chat-header {

            background: linear-gradient(135deg, #91ABE7 0%, #B792C6 100%);

            color: white;

            padding: 20px 24px;

            display: flex;

            align-items: center;

            gap: 16px;

            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);

        }



        .back-btn {

            background: rgba(255, 255, 255, 0.2);

            color: white;

            padding: 10px;

            width: 40px;

            height: 40px;

            border-radius: 10px;

            cursor: pointer;

            border: none;

            display: flex;

            align-items: center;

            justify-content: center;

            transition: all 0.2s;

        }



        .back-btn:hover {

            background: rgba(255, 255, 255, 0.3);

            transform: scale(1.05);

        }



        .back-btn svg {

            width: 20px;

            height: 20px;

        }



        .header-info {

            flex: 1;

        }



        .client-name {

            font-size: 18px;

            font-weight: 700;

            margin-bottom: 2px;

        }



        .client-id-subtitle {

            font-size: 12px;

            opacity: 0.85;

            font-weight: 500;

        }



        .header-status {

            display: flex;

            align-items: center;

            gap: 6px;

            font-size: 11px;

            opacity: 0.9;

        }



        .status-dot {

            width: 8px;

            height: 8px;

            border-radius: 50%;

            background: #4ade80;

            animation: pulse 2s infinite;

        }



        @keyframes pulse {

            0%, 100% {

                opacity: 1;

            }

            50% {

                opacity: 0.5;

            }

        }



        /* CHAT BOX */

        .chat-box {

            flex: 1;

            padding: 20px;

            overflow-y: auto;

            display: flex;

            flex-direction: column;

            gap: 12px;

            scroll-behavior: smooth;

        }



        .chat-box::-webkit-scrollbar {

            width: 6px;

        }



        .chat-box::-webkit-scrollbar-track {

            background: transparent;

        }



        .chat-box::-webkit-scrollbar-thumb {

            background: #cbd5e1;

            border-radius: 3px;

            transition: background 0.3s ease;

        }



        .chat-box::-webkit-scrollbar-thumb:hover {

            background: #94a3b8;

        }



        .empty-chat {

            text-align: center;

            color: #94a3b8;

            font-size: 14px;

            padding: 60px 20px;

            display: flex;

            flex-direction: column;

            align-items: center;

            gap: 12px;

        }



        .empty-chat-icon {

            font-size: 48px;

            opacity: 0.5;

        }



        .message {

            border-radius: 16px;

            padding: 12px 16px;

            max-width: 70%;

            word-wrap: break-word;

            font-size: 14px;

            line-height: 1.5;

            animation: slideIn 0.3s ease-out;

            display: flex;

            flex-direction: column;

            gap: 6px;

        }



        @keyframes slideIn {

            from {

                opacity: 0;

                transform: translateY(10px);

            }

            to {

                opacity: 1;

                transform: translateY(0);

            }

        }



        .message-content {

            word-break: break-word;

        }



        .message-time {

            font-size: 10px;

            opacity: 0.7;

            align-self: flex-end;

        }



        .admin {

            background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);

            color: white;

            margin-left: auto;

            align-self: flex-end;

            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);

        }



        .client {

            background: #e2e8f0;

            color: #1e293b;

            margin-right: auto;

            align-self: flex-start;

            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);

        }



        /* INPUT CONTAINER */

        .input-container {

            padding: 20px 24px;

            background: white;

            border-top: 1px solid #e2e8f0;

            display: flex;

            gap: 12px;

            align-items: center;

        }



        input {

            flex: 1;

            padding: 14px 18px;

            border-radius: 12px;

            border: 2px solid #e2e8f0;

            font-family: 'Inter', sans-serif;

            font-size: 14px;

            color: #1e293b;

            background: #f8fafc;

            transition: all 0.3s ease;

            outline: none;

        }



        input::placeholder {

            color: #94a3b8;

            font-weight: 500;

        }



        input:focus {

            border-color: #a855f7;

            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);

            background: white;

        }



        input:hover {

            border-color: #cbd5e1;

        }



        button {

            padding: 12px;

            background: linear-gradient(135deg, #91ABE7 0%, #B792C6 100%);

            color: white;

            border: none;

            border-radius: 12px;

            font-family: 'Inter', sans-serif;

            font-size: 14px;

            font-weight: 600;

            cursor: pointer;

            transition: all 0.3s ease;

            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);

            display: flex;

            align-items: center;

            justify-content: center;

            min-width: 50px;

            height: 46px;

        }



        button svg {

            width: 20px;

            height: 20px;

        }



        button:hover {

            transform: translateY(-2px);

            box-shadow: 0 6px 16px rgba(168, 85, 247, 0.4);

        }



        button:active {

            transform: translateY(0);

        }



        button:disabled {

            opacity: 0.5;

            cursor: not-allowed;

            transform: none;

        }



        /* DATE SEPARATOR */

        .date-separator {

            text-align: center;

            margin: 16px 0;

            font-size: 12px;

            color: #94a3b8;

            font-weight: 500;

        }



        .date-separator span {

            background: white;

            padding: 6px 16px;

            border-radius: 20px;

            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);

        }



        /* TYPING INDICATOR */

        .typing-indicator {

            display: none;

            align-items: center;

            gap: 8px;

            padding: 10px 16px;

            background: #e2e8f0;

            border-radius: 16px;

            max-width: fit-content;

            margin-right: auto;

        }



        .typing-indicator.active {

            display: flex;

        }



        .typing-dot {

            width: 8px;

            height: 8px;

            border-radius: 50%;

            background: #64748b;

            animation: typing 1.4s infinite;

        }



        .typing-dot:nth-child(2) {

            animation-delay: 0.2s;

        }



        .typing-dot:nth-child(3) {

            animation-delay: 0.4s;

        }



        @keyframes typing {

            0%, 60%, 100% {

                transform: translateY(0);

            }

            30% {

                transform: translateY(-10px);

            }

        }



        @media (max-width: 768px) {

            .chat-header {

                padding: 16px 20px;

            }



            .message {

                max-width: 85%;

                font-size: 13px;

            }



            .input-container {

                padding: 16px 20px;

            }

        }

    </style>

</head>



<body>

    <div class="chat-container">

        <div class="chat-header">

            <button class="back-btn" onclick="goBack()">

                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">

                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />

                </svg>

            </button>

            <div class="header-info">

                <div class="client-name" id="clientName">Cargando...</div>

                <div class="client-id-subtitle" id="clientIdSubtitle"></div>

            </div>

        </div>



        <div class="chat-box" id="chatBox">

            <div class="empty-chat">

                <div class="empty-chat-icon">💬</div>

                <div>Cargando conversación...</div>

            </div>

        </div>



        <div class="input-container">

            <input type="text" id="adminInput" placeholder="Escribe una respuesta...">

            <button id="sendBtn">

                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">

                    <path d="M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z" />

                </svg>

            </button>

        </div>

    </div>



    <script src="https://js.pusher.com/7.0/pusher.min.js"></script>

    <script>

        const chatBox = document.getElementById("chatBox");

        const input = document.getElementById("adminInput");

        const sendBtn = document.getElementById("sendBtn");

        const clientNameEl = document.getElementById("clientName");

        const clientIdSubtitleEl = document.getElementById("clientIdSubtitle");



        // OBTENER CLIENT_ID DE LA URL

        function getClientIdFromUrl() {

            const params = new URLSearchParams(window.location.search);

            return params.get('client_id');

        }



        function isEmbedded() {

            const params = new URLSearchParams(window.location.search);

            return params.get('embedded') === 'true';

        }



        const CLIENT_ID = getClientIdFromUrl();

        const IS_EMBEDDED = isEmbedded();



        if (!CLIENT_ID) {

            alert('Error: No se especificó el cliente');

            if (!IS_EMBEDDED) {

                window.location.href = 'admin_list.html';

            }

        }



        // Mostrar ID en el header

        clientIdSubtitleEl.textContent = CLIENT_ID;



        // CONFIGURAR PUSHER

        const pusher = new Pusher("9918ec022ed3843a467c", { cluster: "sa1" });

        const adminChannel = pusher.subscribe("admin-channel");



        // Escuchar nuevos mensajes del cliente

        adminChannel.bind("new-client-message", function (data) {

            if (data.client_id === CLIENT_ID) {

                console.log('📩 Nuevo mensaje del cliente');



                const msg = document.createElement("div");

                msg.classList.add("message", "client");

                msg.innerHTML = `

                    <div class="message-content">${escapeHtml(data.message)}</div>

                    <div class="message-time">${getCurrentTime()}</div>

                `;

                chatBox.appendChild(msg);

                scrollToBottom();

            }

        });



        // CARGAR MENSAJES EXISTENTES

        async function loadMessages() {

            try {

                const response = await fetch(`https://back-end-chat-master-daniel.onrender.com/chat/messages/${CLIENT_ID}`);

                const data = await response.json();



                if (data.messages && data.messages.length > 0) {

                    chatBox.innerHTML = '';



                    const displayName = generateDisplayName(CLIENT_ID);

                    clientNameEl.textContent = displayName;



                    data.messages.forEach(msg => {

                        const messageDiv = document.createElement("div");

                        const isAdmin = msg.remitente === 'admin';

                        messageDiv.classList.add("message", isAdmin ? "admin" : "client");



                        const time = msg.fecha_envio ? formatTime(msg.fecha_envio) : '';



                        messageDiv.innerHTML = `

                            <div class="message-content">${escapeHtml(msg.contenido)}</div>

                            <div class="message-time">${time}</div>

                        `;

                        chatBox.appendChild(messageDiv);

                    });



                    scrollToBottom();

                } else {

                    chatBox.innerHTML = `

                        <div class="empty-chat">

                            <div class="empty-chat-icon">💬</div>

                            <div>No hay mensajes aún</div>

                            <div style="font-size: 12px; opacity: 0.7;">Inicia la conversación</div>

                        </div>

                    `;

                    clientNameEl.textContent = generateDisplayName(CLIENT_ID);

                }

            } catch (error) {

                console.error('Error al cargar mensajes:', error);

                chatBox.innerHTML = `

                    <div class="empty-chat">

                        <div class="empty-chat-icon">⚠️</div>

                        <div>Error al cargar mensajes</div>

                    </div>

                `;

            }

        }



        // ENVIAR MENSAJE DEL ADMIN

        async function sendAdminMessage() {

            const message = input.value.trim();

            if (message === "") return;



            sendBtn.disabled = true;



            // Mostrar mensaje inmediatamente

            const msg = document.createElement("div");

            msg.classList.add("message", "admin");

            msg.innerHTML = `

                <div class="message-content">${escapeHtml(message)}</div>

                <div class="message-time">${getCurrentTime()}</div>

            `;

            chatBox.appendChild(msg);

            scrollToBottom();

            input.value = "";



            // Enviar al backend

            try {

                await fetch("https://back-end-chat-master-daniel.onrender.com/chat/admin-send", {

                    method: "POST",

                    headers: { "Content-Type": "application/json" },

                    body: JSON.stringify({

                        client_id: CLIENT_ID,

                        message: message

                    })

                });

            } catch (error) {

                console.error('Error al enviar:', error);

                alert('Error al enviar el mensaje');

            } finally {

                sendBtn.disabled = false;

                input.focus();

            }

        }



        // EVENT LISTENERS

        sendBtn.addEventListener("click", sendAdminMessage);



        input.addEventListener("keydown", e => {

            if (e.key === "Enter") {

                sendAdminMessage();

            }

        });



        // NAVEGACIÓN

        function goBack() {

            if (IS_EMBEDDED) {

                // Enviar mensaje al padre para cerrar en móvil

                window.parent.postMessage('close-chat', '*');

            } else {

                window.location.href = 'admin_list.html';

            }

        }



        // UTILIDADES

        function scrollToBottom() {

            chatBox.scrollTop = chatBox.scrollHeight;

        }



        function getCurrentTime() {

            const now = new Date();

            return now.toLocaleTimeString('es-ES', {

                hour: '2-digit',

                minute: '2-digit'

            });

        }



        function formatTime(timestamp) {

            const date = new Date(timestamp);

            return date.toLocaleTimeString('es-ES', {

                hour: '2-digit',

                minute: '2-digit'

            });

        }



        function generateDisplayName(clientId) {

            if (clientId === "admin") return "Administrador";

            if (clientId === "cliente") return "Cliente Único";



            const short = clientId.slice(-4);

            return `Visitante #${short}`;

        }



        function escapeHtml(text) {

            const map = {

                '&': '&amp;',

                '<': '&lt;',

                '>': '&gt;',

                '"': '&quot;',

                "'": '&#039;'

            };

            return text.replace(/[&<>"']/g, m => map[m]);

        }



        // INICIALIZAR

        loadMessages();

        input.focus();



        console.log('✅ Chat admin inicializado');

        console.log('👤 Cliente actual:', CLIENT_ID);

        console.log('📱 Modo embebido:', IS_EMBEDDED);

    </script>

</body>



</html>



