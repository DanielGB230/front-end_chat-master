<!DOCTYPE html>

<html lang="es">



<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Mensajes - Admin</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>

        * {

            margin: 0;

            padding: 0;

            box-sizing: border-box;

        }



        body {

            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);

            color: white;

            display: flex;

            justify-content: center;

            align-items: center;

            min-height: 100vh;

            padding: 20px;

        }



        .main-container {

            background: #ffffff;

            border-radius: 20px;

            width: 100%;

            max-width: 1400px;

            height: 85vh;

            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);

            overflow: hidden;

            display: flex;

        }



        /* LISTA DE CLIENTES */

        .clients-section {

            width: 400px;

            border-right: 1px solid #e2e8f0;

            display: flex;

            flex-direction: column;

            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);

        }



        .header {

            background: linear-gradient(135deg, #91ABE7 0%, #B792C6 100%);

            color: white;

            padding: 24px;

            border-bottom: 1px solid rgba(255, 255, 255, 0.1);

        }



        .header h2 {

            font-size: 22px;

            font-weight: 700;

            margin-bottom: 5px;

        }



        .header p {

            font-size: 13px;

            opacity: 0.9;

        }



        .clients-list {

            overflow-y: auto;

            flex: 1;

        }



        .clients-list::-webkit-scrollbar {

            width: 6px;

        }



        .clients-list::-webkit-scrollbar-thumb {

            background: #cbd5e1;

            border-radius: 3px;

        }



        .client-item {

            display: flex;

            align-items: center;

            padding: 16px 20px;

            border-bottom: 1px solid #e2e8f0;

            cursor: pointer;

            transition: all 0.2s;

            gap: 12px;

            color: #1e293b;

        }



        .client-item:hover {

            background: #f8fafc;

        }



        .client-item.active {

            background: #ede9fe;

            border-left: 3px solid #a855f7;

        }



        .client-avatar {

            width: 48px;

            height: 48px;

            border-radius: 50%;

            background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);

            display: flex;

            align-items: center;

            justify-content: center;

            color: white;

            font-weight: 700;

            font-size: 18px;

            flex-shrink: 0;

        }



        .client-info {

            flex: 1;

            min-width: 0;

        }



        .client-name {

            font-weight: 600;

            font-size: 15px;

            margin-bottom: 4px;

            display: flex;

            align-items: center;

            gap: 6px;

        }



        .badge-visitante {

            background: #f1f5f9;

            color: #64748b;

            font-size: 10px;

            padding: 2px 6px;

            border-radius: 8px;

            font-weight: 500;

        }



        .client-last-message {

            color: #64748b;

            font-size: 13px;

            white-space: nowrap;

            overflow: hidden;

            text-overflow: ellipsis;

        }



        .client-meta {

            display: flex;

            flex-direction: column;

            align-items: flex-end;

            gap: 6px;

        }



        .client-time {

            color: #94a3b8;

            font-size: 11px;

            font-weight: 500;

        }



        .unread-badge {

            background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);

            color: white;

            border-radius: 12px;

            min-width: 22px;

            height: 22px;

            display: flex;

            align-items: center;

            justify-content: center;

            font-size: 11px;

            font-weight: 700;

            padding: 0 6px;

        }



        .empty-state {

            text-align: center;

            padding: 60px 20px;

            color: #94a3b8;

        }



        .empty-state-icon {

            font-size: 48px;

            margin-bottom: 16px;

        }



        .loading {

            text-align: center;

            padding: 40px;

            color: #94a3b8;

        }



        /* CHAT SECTION */

        .chat-section {

            flex: 1;

            display: flex;

            flex-direction: column;

            background: #f8fafc;

        }



        .chat-placeholder {

            display: flex;

            flex-direction: column;

            align-items: center;

            justify-content: center;

            height: 100%;

            color: #94a3b8;

            gap: 16px;

        }



        .chat-placeholder-icon {

            font-size: 80px;

            opacity: 0.3;

        }



        .chat-placeholder-text {

            font-size: 18px;

            font-weight: 500;

        }



        .chat-placeholder-subtext {

            font-size: 14px;

            opacity: 0.7;

        }



        #chatFrame {

            width: 100%;

            height: 100%;

            border: none;

        }



        /* RESPONSIVE */

        @media (max-width: 1024px) {

            .main-container {

                max-width: 100%;

                border-radius: 0;

                height: 100vh;

            }



            .clients-section {

                width: 350px;

            }

        }



        @media (max-width: 768px) {

            .clients-section {

                width: 100%;

                border-right: none;

            }



            .chat-section {

                position: fixed;

                top: 0;

                left: 0;

                right: 0;

                bottom: 0;

                z-index: 1000;

                display: none;

            }



            .chat-section.mobile-active {

                display: flex;

            }



            .clients-section.mobile-hidden {

                display: none;

            }

        }

    </style>

</head>



<body>

    <div class="main-container">

        <!-- LISTA DE CLIENTES -->

        <div class="clients-section" id="clientsSection">

            <div class="header">

                <h2>💬 Mensajes</h2>

                <p>Conversaciones activas</p>

            </div>



            <div class="clients-list" id="clientsList">

                <div class="loading">

                    Cargando conversaciones...

                </div>

            </div>

        </div>



        <!-- CHAT SECTION -->

        <div class="chat-section" id="chatSection">

            <div class="chat-placeholder">

                <div class="chat-placeholder-icon">💬</div>

                <div class="chat-placeholder-text">Selecciona una conversación</div>

                <div class="chat-placeholder-subtext">Elige un cliente de la lista para comenzar a chatear</div>

            </div>

        </div>

    </div>



    <script src="https://js.pusher.com/7.0/pusher.min.js"></script>

    <script>

        let currentClientId = null;



        // CONFIGURAR PUSHER

        const pusher = new Pusher("9918ec022ed3843a467c", { cluster: "sa1" });

        const adminChannel = pusher.subscribe("admin-channel");



        // Escuchar nuevos mensajes de clientes

        adminChannel.bind("new-client-message", function (data) {

            console.log('📩 Nuevo mensaje de:', data.client_id);

            loadClients();



            // Notificación visual

            if (Notification.permission === "granted") {

                new Notification('Nuevo mensaje', {

                    body: `${data.client_id}: ${data.message}`

                });

            }

        });



        // CARGAR LISTA DE CLIENTES

        async function loadClients() {

            try {

                const response = await fetch('https://back-end-chat-master-daniel.onrender.com/chat/clients');

                const data = await response.json();



                if (data.clients && data.clients.length > 0) {

                    renderClients(data.clients);

                } else {

                    showEmptyState();

                }

            } catch (error) {

                console.error('Error al cargar clientes:', error);

                showError();

            }

        }



        function renderClients(clients) {

            const container = document.getElementById('clientsList');



            container.innerHTML = clients.map(client => `

                <div class="client-item ${currentClientId === client.client_id ? 'active' : ''}" 

                     onclick="openChat('${client.client_id}')">

                    <div class="client-avatar">

                        ${getAvatarLetter(client.display_name)}

                    </div>

                    <div class="client-info">

                        <div class="client-name">

                            ${escapeHtml(client.display_name)}

                            ${client.client_id.startsWith('guest_') ? '<span class="badge-visitante">Visitante</span>' : ''}

                        </div>

                        <div class="client-last-message">

                            ${escapeHtml(client.last_message) || 'Sin mensajes'}

                        </div>

                    </div>

                    <div class="client-meta">

                        <div class="client-time">${formatTime(client.last_timestamp)}</div>

                        ${client.unread_count > 0 ? `<div class="unread-badge">${client.unread_count}</div>` : ''}

                    </div>

                </div>

            `).join('');

        }



        function showEmptyState() {

            const container = document.getElementById('clientsList');

            container.innerHTML = `

                <div class="empty-state">

                    <div class="empty-state-icon">💬</div>

                    <div>No hay conversaciones aún</div>

                </div>

            `;

        }



        function showError() {

            const container = document.getElementById('clientsList');

            container.innerHTML = `

                <div class="empty-state">

                    <div class="empty-state-icon">⚠️</div>

                    <div>Error al cargar conversaciones</div>

                </div>

            `;

        }



        // ABRIR CHAT EN IFRAME

        function openChat(clientId) {

            currentClientId = clientId;



            const chatSection = document.getElementById('chatSection');

            chatSection.innerHTML = `<iframe id="chatFrame" src="admin_chat.html?client_id=${clientId}&embedded=true"></iframe>`;



            // Marcar como activo en la lista

            loadClients();



            // En móvil, ocultar lista y mostrar chat

            if (window.innerWidth <= 768) {

                document.getElementById('clientsSection').classList.add('mobile-hidden');

                chatSection.classList.add('mobile-active');

            }

        }



        // Escuchar mensajes del iframe para cerrar en móvil

        window.addEventListener('message', function (event) {

            if (event.data === 'close-chat') {

                if (window.innerWidth <= 768) {

                    document.getElementById('clientsSection').classList.remove('mobile-hidden');

                    document.getElementById('chatSection').classList.remove('mobile-active');

                }

            }

        });



        // UTILIDADES

        function formatTime(timestamp) {

            if (!timestamp) return '';



            const date = new Date(timestamp);

            const now = new Date();

            const diff = now - date;



            if (diff < 86400000) {

                return date.toLocaleTimeString('es-ES', {

                    hour: '2-digit',

                    minute: '2-digit'

                });

            }



            return date.toLocaleDateString('es-ES', {

                day: '2-digit',

                month: '2-digit'

            });

        }



        function getAvatarLetter(displayName) {

            if (!displayName) return '?';

            return displayName.charAt(0).toUpperCase();

        }



        function escapeHtml(text) {

            if (!text) return '';

            const map = {

                '&': '&amp;',

                '<': '&lt;',

                '>': '&gt;',

                '"': '&quot;',

                "'": '&#039;'

            };

            return text.replace(/[&<>"']/g, m => map[m]);

        }



        // PEDIR PERMISOS DE NOTIFICACIÓN

        if (Notification.permission === "default") {

            Notification.requestPermission();

        }



        // INICIALIZAR

        loadClients();

        setInterval(loadClients, 30000);



        console.log('✅ Panel admin inicializado');

    </script>

</body>



</html>



